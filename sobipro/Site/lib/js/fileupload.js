/**
 * @package: SobiPro Library
 *
 * @author
 * Name: Sigrid Suski & Radek Suski, Sigsiu.NET GmbH
 * Email: sobi[at]sigsiu.net
 * Url: https://www.Sigsiu.NET
 *
 * @copyright Copyright (C) 2006 - 2022 Sigsiu.NET GmbH (https://www.sigsiu.net). All rights reserved.
 * @license GNU/LGPL Version 3
 * This program is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser General Public License version 3
 *  as published by the Free Software Foundation, and under the additional terms according section 7 of GPL v3.
 * See https://www.gnu.org/licenses/lgpl.html and https://www.sigsiu.net/licenses.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.
 *
 * @modified 15 December 2022 by Sigrid Suski
 */
SobiPro.jQuery.fn.SobiProFileUploader=function(e){let t=this;this.settings={hideProgressBar:!0,styles:{".progress":{margin:"10px 0 10px 0"},".alert":{clear:"both","margin-top":".3rem","margin-bottom":".3rem"}}},this.settings=SobiPro.jQuery.extend(!0,e,this.settings),SobiPro.jQuery.each(this.settings.styles,(function(e,i){t.find(e).css(i)}));let i=t.find(".progress-bar"),n=t.find(".progress-container"),r=t.find('[role="progressbar"]'),o=t.find(".alert"),l=t.find(".idStore"),a=t.find(".upload");return this.complete=function(e){t.trigger("uploadComplete",[e]);let s="100%";i.width(s).attr("aria-valuenow","100"),r.html(s);let d=SobiPro.jQuery.parseJSON(e.responseText);if(t.settings.hideProgressBar&&n.addClass("hidden"),d.callback){(0,window[d.callback])(d,t)}else o.removeClass("hidden"),o.removeClass("alert-error").removeClass("alert-danger").removeClass("alert-success"),o.addClass("alert-"+d.type),o.find("div").html(d.text),l.val(d.id),a.attr("disabled","disabled");let f=l.attr("name");SobiPro.jQuery("#"+f+"-container").find(".invalid-feedback").css("display","none").text(""),t[0].querySelector(".spctrl-fileupload").dispatchEvent(new CustomEvent("spUploadCompleted",{bubbles:!0,detail:{file:l[0].value,status:d.type}}))},this.uploadProgress=function(e,n,o,l){t.trigger("uploadProgress",[e,n,o,l]);let a=l+"%";i.width(a).attr("aria-valuenow",l),r.html(a)},this.beforeSend=function(){t.trigger("beforeSend",[this]),n.removeClass("hidden");i.width("0%").attr("aria-valuenow","0"),r.html("0%")},this.upload=function(){let e=SobiPro.jQuery.parseJSON(t.find(".upload").attr("rel"));t.trigger("createRequest",[e]);let i=t.find(".spctrl-fileupload"),n=t.find("input:file"),r=n.attr("name")+"-form",o='<form action="'+("site"===site?SPLiveSite+"index.php":SPLiveSite+"administrator/index.php")+'" method="post" enctype="multipart/form-data" id="'+r+'">';for(let t in e)o+='<input type="hidden" value="'+e[t]+'" name="'+t+'"/>';o+="</form>",o=SobiPro.jQuery(o),n.appendTo(o);let l=n.clone(n);l.prependTo(i),5===bs&&n.addClass("hidden"),4===bs?t.find(".custom-file-label").html(t.getFilename(l)):bs<4&&t.find(".selected").val(t.getFilename(l)),o.appendTo(SobiPro.jQuery("#SobiPro")),SobiPro.jQuery("#"+r).ajaxForm({dataType:"json",beforeSend:function(){t.beforeSend()},uploadProgress:function(e,i,n,r){t.uploadProgress(e,i,n,r)},complete:function(e){t.complete(e),o.detach()}}).submit()},this.getFilename=function(e){let t=e.val(),i=t.indexOf("\\")>=0?t.lastIndexOf("\\"):t.lastIndexOf("/"),n=t.substring(i);return 0!==n.indexOf("\\")&&0!==n.indexOf("/")||(n=n.substring(1)),n},this.attachListener=function(e){e.change((function(){if(e.val()){t.find(".upload, .remove").removeAttr("disabled"),t.find(".upload, .remove").removeClass("disabled");let i=t.getFilename(e);4===bs?t.find(".custom-file-label").html(i):bs<4&&t.find(".selected").val(i),setTimeout((function(){t.upload()}),500)}}))},this.attachListener(t.find("input:file")),t.find(".select").click((function(){t.find("input:file").trigger("click")})),t.find(".remove").click((function(){let e=t.find("input:file"),i=e.clone(e);if(t.find(".upload, .remove").attr("disabled","disabled"),5===bs?t.find("input:file").html(""):4===bs?t.find(".custom-file-label").html(""):bs<4&&t.find(".selected").val(""),t.find(".idStore").val(""),i.prependTo(e.parent()),5===bs){let i=t.find("label"),n=t.find("button");i.appendTo(e.parent()),n.appendTo(e.parent())}e.remove()})),t.find(".upload").click((function(){t.upload()})),this},SobiPro.jQuery.fn.SPFileUploader=function(e){return this.each((function(){SobiPro.jQuery(this).SobiProFileUploader(e)}))};